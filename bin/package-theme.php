<?php
error_reporting(E_ALL & ~E_STRICT & ~E_DEPRECATED);
require_once('PEAR/PackageFileManager2.php');
PEAR::setErrorHandling(PEAR_ERROR_DIE);

function createPackager($theme, $options = array())
{
  $settings = simplexml_load_file(
      dirname(__FILE__).'/../data/themes/' . $theme . '/template.xml'
  );
  $version     = (string)$settings->version;
  $author      = (string)$settings->author;
  $description = (string)$settings->description;
  $email       = (string)$settings->email;

  // merge the options with these defaults.
  $options = array_merge(array(
    'packagefile'       => 'package.xml',
    'filelistgenerator' => 'file',
    'simpleoutput'      => true,
    'baseinstalldir'    => '/DocBlox/themes/'.$theme,
    'packagedirectory'  => dirname(__FILE__).'/../data/themes/' . $theme,
    'clearcontents'     => true,
    'ignore'            => array(),
    'exceptions'        => array(),
    'installexceptions' => array(),
    'dir_roles'         => array(
      '.'   => 'data',
    ),
  ), $options);

  $packagexml = PEAR_PackageFileManager2::importOptions(
      '', $options
  );
  $packagexml->setPackageType('php');

  $packagexml->setPackage('DocBlox_Theme_' . $theme);
  $packagexml->setSummary('The ' . $theme . ' theme for DocBlox');
  $packagexml->setDescription($description);
  $packagexml->setChannel('pear.docblox-project.org');
  $packagexml->setNotes('Automatically generated by the DocBlox packager');

  $packagexml->setPhpDep('5.2.6');
  $packagexml->setPearinstallerDep('1.4.0');
  $packagexml->addPackageDepWithChannel('required', 'PEAR', 'pear.php.net', '1.4.0');
//  $packagexml->addPackageDepWithChannel('required', 'DocBlox', 'pear.docblox-project.org', '0.16.0');

  $packagexml->addMaintainer('lead', '', $author, $email);
  $packagexml->setLicense('MIT', 'http://www.opensource.org/licenses/mit-license.html');

  // Add this as a release, and generate XML content
  $packagexml->addRelease();

  $packagexml->setAPIVersion($version);
  $packagexml->setReleaseVersion($version);
  $packagexml->setReleaseStability('stable');
  $packagexml->setAPIStability('stable');

  return $packagexml;
}


echo 'DocBlox PEAR Theme Packager v1.0'.PHP_EOL;

if ($argc < 1)
{
  echo <<<HELP

Usage:
  php package.php [theme] [make|nothing]

Description:
  The DocBlox packager generates a package.xml file and accompanying package.
  By specifying the version and stability you can tell the packager which version to package.

  A file will only be generated if the third parameter is the word 'make'; otherwise the output will be send to
  the command line.

HELP;
  exit(0);
}

$packager = createPackager($argv[1]);
$packager->generateContents();
if (isset($argv[2]) && ($argv[2] == 'make')) {
  $packager->writePackageFile();
} else {
  $packager->debugPackageFile();
}
